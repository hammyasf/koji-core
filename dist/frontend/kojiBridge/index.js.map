{"version":3,"sources":["../../../src/frontend/kojiBridge/index.ts"],"names":["KojiBridge","callback","eventName","messageListener","data","event","window","addEventListener","removeEventListener","postMessage","parent","_kojiEventName","kojiEventName","_type","_feedKey","location","hash","replace","platformMessageName","Promise","resolve","reject","idempotencyKey","_idempotencyKey","err"],"mappings":";;;;;;;;;;;;;;;AACA;;;;;;IAYaA,U;;;;;;;0CACqBC,Q,EAAoBC,S,EAAmB;AACrE,UAAMC,eAAe,GAAG,SAAlBA,eAAkB,OAA6C;AAAA,YAA1CC,IAA0C,QAA1CA,IAA0C;AAAA,YAC3DC,KAD2D,GACjDD,IADiD,CAC3DC,KAD2D;;AAEnE,YAAIA,KAAK,KAAKH,SAAd,EAAyB;AACvBD,UAAAA,QAAQ,CAACG,IAAD,CAAR;AACD;AACF,OALD;;AAOAE,MAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmCJ,eAAnC;AAEA,aAAO,YAAM;AACXG,QAAAA,MAAM,CAACE,mBAAP,CAA2B,SAA3B,EAAsCL,eAAtC;AACD,OAFD;AAGD;;;gCAEqBM,W,EAAgC;AACpDH,MAAAA,MAAM,CAACI,MAAP,CAAcD,WAAd;AAEIE,QAAAA,cAAc,EAAEF,WAAW,CAACG,aAFhC;AAGIC,QAAAA,KAAK,EAAEJ,WAAW,CAACG,aAHvB;AAIIE,QAAAA,QAAQ,EAAER,MAAM,CAACS,QAAP,CAAgBC,IAAhB,CAAqBC,OAArB,CAA6B,iBAA7B,EAAgD,EAAhD;AAJd,SAKOR,WAAW,CAACL,IALnB,GAOE,GAPF;AASD;;;gDAEqCK,W,EAA0BS,mB,EAA2C;AACzG,aAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,YAAMC,cAAc,GAAG,eAAvB;;AAEA,YAAMnB,eAAe,GAAG,SAAlBA,eAAkB,QAA6C;AAAA,cAA1CC,IAA0C,SAA1CA,IAA0C;AAAA,cAC3DC,KAD2D,GAChCD,IADgC,CAC3DC,KAD2D;AAAA,cACpDkB,eADoD,GAChCnB,IADgC,CACpDmB,eADoD;;AAEnE,cAAIlB,KAAK,KAAKa,mBAAV,IAAiCI,cAAc,KAAKC,eAAxD,EAAyE;AACvE,gBAAI;AACFH,cAAAA,OAAO,CAAChB,IAAD,CAAP;AACD,aAFD,CAEE,OAAOoB,GAAP,EAAY;AACZH,cAAAA,MAAM,CAACG,GAAD,CAAN;AACD;;AACDlB,YAAAA,MAAM,CAACE,mBAAP,CAA2B,SAA3B,EAAsCL,eAAtC;AACD;AACF,SAVD;;AAYAG,QAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmCJ,eAAnC;AAEAG,QAAAA,MAAM,CAACI,MAAP,CAAcD,WAAd;AAEIE,UAAAA,cAAc,EAAEF,WAAW,CAACG,aAFhC;AAGIC,UAAAA,KAAK,EAAEJ,WAAW,CAACG,aAHvB;AAIIE,UAAAA,QAAQ,EAAER,MAAM,CAACS,QAAP,CAAgBC,IAAhB,CAAqBC,OAArB,CAA6B,iBAA7B,EAAgD,EAAhD,CAJd;AAKIM,UAAAA,eAAe,EAAED;AALrB,WAMOb,WAAW,CAACL,IANnB,GAQE,GARF;AAUD,OA3BM,CAAP;AA4BD","sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\nimport { v4 as uuidv4 } from 'uuid';\n\ninterface MessageListenerData {\n  event: string;\n  _idempotencyKey?: string;\n}\n\ninterface PostMessage {\n  kojiEventName: string;\n  data?: any;\n}\n\nexport class KojiBridge {\n  protected execCallbackOnMessage(callback: Function, eventName: string) {\n    const messageListener = ({ data }: { data: MessageListenerData }) => {\n      const { event } = data;\n      if (event === eventName) {\n        callback(data);\n      }\n    };\n\n    window.addEventListener('message', messageListener);\n\n    return () => {\n      window.removeEventListener('message', messageListener);\n    };\n  }\n\n  protected sendMessage(postMessage: PostMessage): void {\n    window.parent.postMessage(\n      {\n        _kojiEventName: postMessage.kojiEventName,\n        _type: postMessage.kojiEventName,\n        _feedKey: window.location.hash.replace('#koji-feed-key=', ''),\n        ...postMessage.data,\n      },\n      '*',\n    );\n  }\n\n  protected sendMessageAndAwaitResponse(postMessage: PostMessage, platformMessageName: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const idempotencyKey = uuidv4();\n\n      const messageListener = ({ data }: { data: MessageListenerData }) => {\n        const { event, _idempotencyKey } = data;\n        if (event === platformMessageName && idempotencyKey === _idempotencyKey) {\n          try {\n            resolve(data);\n          } catch (err) {\n            reject(err);\n          }\n          window.removeEventListener('message', messageListener);\n        }\n      };\n\n      window.addEventListener('message', messageListener);\n\n      window.parent.postMessage(\n        {\n          _kojiEventName: postMessage.kojiEventName,\n          _type: postMessage.kojiEventName,\n          _feedKey: window.location.hash.replace('#koji-feed-key=', ''),\n          _idempotencyKey: idempotencyKey,\n          ...postMessage.data,\n        },\n        '*',\n      );\n    });\n  }\n}\n"],"file":"index.js"}