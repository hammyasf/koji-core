{"version":3,"sources":["../../../src/backend/iap/index.ts"],"names":["IapRoutes","IAP","res","projectId","locals","process","env","KOJI_PROJECT_ID","projectToken","KOJI_PROJECT_TOKEN","rootPath","rootHeaders","userToken","axios","post","RESOLVE_RECEIPTS","headers","data","receiptId","RESOLVE_RECEIPT_BY_ID","sku","RESOLVE_RECEIPTS_BY_SKU","attributes","notificationMessage","UPDATE_RECEIPT","Error","get","GET_PRODUCT_BY_SKU","server"],"mappings":";;;;;;;;;;;;;;;;;;;;;AACA;;AACA;;;;;;;;IAEYA,S;;;WAAAA,S;AAAAA,EAAAA,S;AAAAA,EAAAA,S;AAAAA,EAAAA,S;AAAAA,EAAAA,S;AAAAA,EAAAA,S;GAAAA,S,yBAAAA,S;;IAsBCC,G;AAMX,eAAYC,GAAZ,EAA2B;AAAA;AAAA;AAAA;AAAA;AAAA;AACzB,SAAKC,SAAL,GAAiBD,GAAG,CAACE,MAAJ,CAAWD,SAAX,IAAwBE,OAAO,CAACC,GAAR,CAAYC,eAArD;AACA,SAAKC,YAAL,GAAoBN,GAAG,CAACE,MAAJ,CAAWI,YAAX,IAA2BH,OAAO,CAACC,GAAR,CAAYG,kBAA3D;AAEA,SAAKC,QAAL,GAAgB,6BAAhB;AAEA,SAAKC,WAAL,GAAmB;AACjB,2BAAqB,KAAKR,SADT;AAEjB,8BAAwB,KAAKK,YAFZ;AAGjB,sBAAgB;AAHC,KAAnB;AAKD;;;;;uIAGuCI,S;;;;;;;;;uBAEbC,kBAAMC,IAAN,WAClB,KAAKJ,QADa,SACFV,SAAS,CAACe,gBADR,GAErB,EAFqB,EAGrB;AACEC,kBAAAA,OAAO,kCACF,KAAKL,WADH;AAEL,iDAA6BC;AAFxB;AADT,iBAHqB,C;;;;AAAfK,gBAAAA,I,qBAAAA,I;iDAWDA,I;;;;;iDAEA,E;;;;;;;;;;;;;;;;;;;gIAKqBC,S;;;;;;;;;uBAELL,kBAAMC,IAAN,WAClB,KAAKJ,QADa,SACFV,SAAS,CAACmB,qBADR,GAErB;AAAED,kBAAAA,SAAS,EAATA;AAAF,iBAFqB,EAGrB;AAAEF,kBAAAA,OAAO,EAAE,KAAKL;AAAhB,iBAHqB,C;;;;AAAfM,gBAAAA,I,sBAAAA,I;kDAMDA,I;;;;;kDAEA,I;;;;;;;;;;;;;;;;;;;kIAKuBG,G;;;;;;;;;uBAEPP,kBAAMC,IAAN,WAClB,KAAKJ,QADa,SACFV,SAAS,CAACqB,uBADR,GAErB;AAAED,kBAAAA,GAAG,EAAHA;AAAF,iBAFqB,EAGrB;AAAEJ,kBAAAA,OAAO,EAAE,KAAKL;AAAhB,iBAHqB,C;;;;AAAfM,gBAAAA,I,sBAAAA,I;kDAMDA,I;;;;;kDAEA,E;;;;;;;;;;;;;;;;;;;2HAKTC,S,EACAI,U,EACAC,mB;;;;;;;;;uBAGyBV,kBAAMC,IAAN,WAClB,KAAKJ,QADa,SACFV,SAAS,CAACwB,cADR,GAErB;AACEN,kBAAAA,SAAS,EAATA,SADF;AAEEI,kBAAAA,UAAU,EAAVA,UAFF;AAGEC,kBAAAA,mBAAmB,EAAnBA;AAHF,iBAFqB,EAOrB;AAAEP,kBAAAA,OAAO,EAAE,KAAKL;AAAhB,iBAPqB,C;;;;AAAfM,gBAAAA,I,sBAAAA,I;kDAUDA,I;;;;;sBAED,IAAIQ,KAAJ,CAAU,eAAV,C;;;;;;;;;;;;;;;;;;;yHAIeL,G;;;;;;;;;uBAEEP,kBAAMa,GAAN,WAClB,KAAKhB,QADa,SACFV,SAAS,CAAC2B,kBADR,oBACoC,KAAKxB,SADzC,kBAC0DiB,GAD1D,GAErB;AAAEJ,kBAAAA,OAAO,EAAE,KAAKL;AAAhB,iBAFqB,C;;;;AAAfM,gBAAAA,I,oBAAAA,I;kDAKDA,I;;;;;kDAEA,I;;;;;;;;;;;;;;;;;;0GAjFVW,c,2LAoBAA,c,qLAeAA,c","sourcesContent":["import { Response } from 'express';\nimport axios from 'axios';\nimport { server } from '../@decorators/server';\n\nexport enum IapRoutes {\n  GET_PRODUCT_BY_SKU = '/v1/iap/provider/getProductBySku',\n  RESOLVE_RECEIPTS = '/v1/iap/consumer/resolveReceipts',\n  RESOLVE_RECEIPT_BY_ID = '/v1/iap/consumer/resolveReceiptById',\n  RESOLVE_RECEIPTS_BY_SKU = '/v1/iap/consumer/resolveReceiptsBySku',\n  UPDATE_RECEIPT = '/v1/iap/consumer/updateReceiptAttributes',\n}\n\nexport type UserToken = string;\n\nexport interface IapReceipt {\n  receiptId: string;\n  productId: string;\n  purchasedPrice: number;\n  attributes: { [index: string]: any };\n  transactionIds: {\n    credit: string;\n    debit: string;\n  };\n  datePurchased: Date;\n}\n\nexport class IAP {\n  private projectId: string;\n  private projectToken: string;\n  private rootPath: string;\n  private rootHeaders: Object;\n\n  constructor(res: Response) {\n    this.projectId = res.locals.projectId || process.env.KOJI_PROJECT_ID;\n    this.projectToken = res.locals.projectToken || process.env.KOJI_PROJECT_TOKEN;\n\n    this.rootPath = 'https://rest.api.gokoji.com';\n\n    this.rootHeaders = {\n      'X-Koji-Project-Id': this.projectId,\n      'X-Koji-Project-Token': this.projectToken,\n      'Content-Type': 'application/json',\n    };\n  }\n\n  @server\n  public async resolveReceiptsByUserToken(userToken: UserToken): Promise<IapReceipt[]> {\n    try {\n      const { data } = await axios.post(\n        `${this.rootPath}${IapRoutes.RESOLVE_RECEIPTS}`,\n        {},\n        {\n          headers: {\n            ...this.rootHeaders,\n            'X-Koji-Iap-Callback-Token': userToken,\n          },\n        },\n      );\n\n      return data;\n    } catch (err) {\n      return [];\n    }\n  }\n\n  @server\n  public async resolveReceiptById(receiptId: string): Promise<IapReceipt | null> {\n    try {\n      const { data } = await axios.post(\n        `${this.rootPath}${IapRoutes.RESOLVE_RECEIPT_BY_ID}`,\n        { receiptId },\n        { headers: this.rootHeaders },\n      );\n\n      return data;\n    } catch (err) {\n      return null;\n    }\n  }\n\n  @server\n  public async resolveReceiptsBySku(sku: string): Promise<IapReceipt[]> {\n    try {\n      const { data } = await axios.post(\n        `${this.rootPath}${IapRoutes.RESOLVE_RECEIPTS_BY_SKU}`,\n        { sku },\n        { headers: this.rootHeaders },\n      );\n\n      return data;\n    } catch (err) {\n      return [];\n    }\n  }\n\n  public async updateReceipt(\n    receiptId: string,\n    attributes: { [index: string]: any },\n    notificationMessage?: string,\n  ): Promise<any> {\n    try {\n      const { data } = await axios.post(\n        `${this.rootPath}${IapRoutes.UPDATE_RECEIPT}`,\n        {\n          receiptId,\n          attributes,\n          notificationMessage,\n        },\n        { headers: this.rootHeaders },\n      );\n\n      return data;\n    } catch (err) {\n      throw new Error('Service error');\n    }\n  }\n\n  public async loadProduct(sku: string) {\n    try {\n      const { data } = await axios.get(\n        `${this.rootPath}${IapRoutes.GET_PRODUCT_BY_SKU}?appId=${this.projectId}&sku=${sku}`,\n        { headers: this.rootHeaders },\n      );\n\n      return data;\n    } catch (err) {\n      return null;\n    }\n  }\n}\n\nexport interface IIAP extends IAP {}\n"],"file":"index.js"}